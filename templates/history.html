{% extends "base.html" %}
{% block title %}History{% endblock %}

{% block content %}
    <h2>ðŸ“œ Prediction History</h2>

    <!-- Table of predictions -->
    {% if predictions %}
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Input Text</th>
                    <th>Predicted Label</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for row in predictions %}
                <tr>
                    <td>{{ row.id }}</td>
                    <td>{{ row.input_text }}</td>
                    <td>{{ row.predicted_label }}</td>
                    <td>{{ row.created_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-muted">No predictions yet.</p>
    {% endif %}

    <!-- Charts -->
    <div class="row mt-5">
        <div class="col-md-6">
            <h4 class="text-center mb-3">Sentiment Distribution</h4>
            <canvas id="pieChart"></canvas>
        </div>
        <div class="col-md-6">
            <h4 class="text-center mb-3">Sentiment Counts</h4>
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Explicitly parse the JSON string from the backend for better syntax highlighting
            const sentimentCountsStr = '{{ sentiment_counts | tojson | safe }}';
            const sentimentCounts = JSON.parse(sentimentCountsStr);
            
            const labels = Object.keys(sentimentCounts);
            const values = Object.values(sentimentCounts);
            const colors = ['#28a745', '#dc3545', '#ffc107'];

            if (values.some(v => v > 0)) {
                new Chart(document.getElementById('pieChart'), {
                    type: 'pie',
                    data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });

                new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Sentiment Count', data: values, backgroundColor: colors }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            } else {
                document.getElementById('pieChart').parentElement.innerHTML =
                    '<p class="text-center text-muted">No data yet. Make some predictions!</p>';
                document.getElementById('barChart').parentElement.innerHTML =
                    '<p class="text-center text-muted">Charts will appear here.</p>';
            }
        });
    </script>
{% endblock %}